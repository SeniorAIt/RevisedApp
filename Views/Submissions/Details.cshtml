@model WorkbookManagement.Models.Submission
@using WorkbookManagement.Models
@{
    ViewData["Title"] = "Submission Details";

    var total = Model.Workbooks?.Count ?? 0;
    var done = Model.Workbooks?.Count(w => w.Status != SubmissionStatus.Draft) ?? 0;
    var allCompleted = (total == 3 && done == 3);

    bool canDeleteSubmission = Model.Status == SubmissionBundleStatus.Draft;
    bool canSubmitBundle = allCompleted && Model.Status is not (SubmissionBundleStatus.Submitted or SubmissionBundleStatus.Approved or SubmissionBundleStatus.Rejected);

    string SubmissionBadge(SubmissionBundleStatus s) => s switch
    {
        SubmissionBundleStatus.InProgress => "badge bg-warning text-dark",
        SubmissionBundleStatus.Completed => "badge bg-success",
        SubmissionBundleStatus.Submitted => "badge bg-info",
        SubmissionBundleStatus.Approved => "badge bg-success",
        SubmissionBundleStatus.Rejected => "badge bg-danger",
        _ => "badge bg-secondary"
    };

    string WorkbookBadge(SubmissionStatus s) => s switch
    {
        SubmissionStatus.Submitted => "badge bg-info",
        SubmissionStatus.Approved => "badge bg-success",
        SubmissionStatus.Completed => "badge bg-success",
        _ => "badge bg-secondary"
    };
}

<div class="d-flex justify-content-between align-items-center mb-2">
    <h2 class="mb-0">Submission <code>@Model.Id.ToString().Substring(0, 8)</code></h2>

    @if (canDeleteSubmission)
    {
        <form asp-controller="Submissions" asp-action="Delete" asp-route-id="@Model.Id"
              method="post" class="d-inline"
              onsubmit="return confirm('Delete this submission and all its workbooks? This action cannot be undone.');">
            @Html.AntiForgeryToken()
            <button class="btn btn-outline-danger btn-sm" type="submit">Delete submission</button>
        </form>
    }
    else
    {
        <button class="btn btn-outline-danger btn-sm" type="button" disabled
                title="Only draft submissions can be deleted">
            Delete submission
        </button>
    }
</div>

@if (TempData["ok"] is string ok)
{
    <div class="alert alert-success">@ok</div>
}
@if (TempData["err"] is string err)
{
    <div class="alert alert-danger">@err</div>
}

<div class="mb-3">
    <strong>Company:</strong> @Model.Company.Name<br />
    <strong>Status:</strong>
    <span class="@SubmissionBadge(Model.Status)">@Model.Status</span>
</div>

<div class="table-responsive">
    <table class="table table-sm align-middle">
        <thead>
            <tr>
                <th>Workbook</th>
                <th>Type</th>
                <th>Status</th>
                <th>Updated</th>
                <th class="text-end" style="width:180px;">Actions</th>
            </tr>
        </thead>
        <tbody>
            @foreach (var w in Model.Workbooks.OrderBy(x => x.WorkbookType))
            {
                <tr>
                    <td>@w.Title</td>
                    <td>@w.WorkbookType</td>
                    <td><span class="@WorkbookBadge(w.Status)">@w.Status</span></td>
                    <td>@w.UpdatedAt.ToLocalTime().ToString("yyyy/MM/dd HH:mm")</td>
                    <td class="text-end">
                        <!-- Open goes to the smart Workbooks/Open action -->
                        <a class="btn btn-primary btn-sm"
                           asp-controller="Workbooks" asp-action="Open" asp-route-id="@w.Id">Open</a>

                        <!-- Delete workbook (POST) -->
                        <form asp-controller="Workbooks" asp-action="Delete" asp-route-id="@w.Id"
                              method="post" class="d-inline"
                              onsubmit="return confirm('Delete this workbook?');">
                            @Html.AntiForgeryToken()
                            <button class="btn btn-danger btn-sm" type="submit">Delete</button>
                        </form>
                    </td>
                </tr>
            }
        </tbody>
    </table>
</div>

<div class="d-flex gap-2">
    <a class="btn btn-outline-secondary" asp-action="Index">Back</a>

    @if (canSubmitBundle)
    {
        <form asp-action="Submit" asp-route-id="@Model.Id" method="post"
              onsubmit="return confirm('Submit this bundle? No further edits will be allowed unless reopened.');">
            @Html.AntiForgeryToken()
            <button class="btn btn-success" type="submit">Submit All</button>
        </form>
    }
    else
    {
        <button class="btn btn-success" type="button" disabled
                title="Complete all 3 workbooks (and ensure it’s not already Submitted/Approved/Rejected)">
            Submit All
        </button>
    }
</div>
